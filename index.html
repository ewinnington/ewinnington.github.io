
<!DOCTYPE html>
<!--
	Phantom by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html lang="en">

	<head>
		<title>Eric Winnington</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />		
        <link href="/assets/css/highlight.css" rel="stylesheet">
		<!--[if lte IE 8]><script src="/assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="/assets/css/main.css" />
		<!--[if lte IE 9]><link rel="stylesheet" href="/assets/css/ie9.css" /><![endif]-->
		<!--[if lte IE 8]><link rel="stylesheet" href="/assets/css/ie8.css" /><![endif]-->
        <link href="/assets/css/override.css" rel="stylesheet" />

		<meta name="description" content="A collection of thoughts, code and snippets." />
		<link type="application/rss+xml" rel="alternate" title="Eric Winnington" href="/feed.rss" />
				<link type="application/atom+xml" rel="alternate" title="Eric Winnington" href="/feed.atom" />
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="icon" href="/favicon.ico" type="image/x-icon">

		<meta name="application-name" content="Eric Winnington" />
		<meta name="msapplication-tooltip" content="Eric Winnington" />
		<meta name="msapplication-starturl" content="/" />

		<meta property="og:title" content="Eric Winnington" /> 
		<meta property="og:type" content="website" />
		<meta property="og:url" content="http://ewinnington.github.io/" />
		<!-- TODO: More social graph meta tags -->

        <script src="/assets/js/highlight.pack.js"></script>   
		
        <meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@ewinnington" />
<meta name="twitter:title" content="Eric Winnington" />
<meta name="twitter:description" content="A collection of thoughts, code and snippets." />

<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
		
	</head>

	<body>
		<!-- Wrapper -->
		<div id="wrapper">

			<!-- Header -->
			<header id="header">
				<div class="inner">

					<!-- Logo -->
					<a href="/" class="logo">
						<span class="title">Eric Winnington</span>
					</a>

					<!-- Nav -->
					<nav>
						<ul>
							<li><a href="#menu">Menu</a></li>
						</ul>
					</nav>

				</div>
			</header>

			<!-- Menu -->
			<nav id="menu">
				<h2>Menu</h2>
				<ul>
					        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About Me</a></li>
        <li><a href="/videos">Videos on programming</a></li>

				</ul>
			</nav>

			<!-- Main -->
			<div id="main">
				<div class="inner">

    <header>
        <h1>A collection of thoughts, code and snippets.</h1>
    </header>

					
					<div id="content">
						
<div class="row">
    <div class="8u 12u$(medium)">
                <div>
                    <a href="/posts/Software-Architecture-Illustration">
                        <h2>Software Architecture illustrations</h2>
                    </a>
                    <p>Posted on Wednesday, 16 November 2022</p>
<h1 id="illustrations-in-software-architecture">Illustrations in Software architecture</h1>
<p>In software architecture, I find myself reaching more and more for tools that I can use to generate representations from a simple textual description, be it generated from a tool or hand written. And sometimes, nothing generated looks nice, so I have to do draw it myself!</p>
<p>Here are a few of the tools I have recently used, for different purposes:</p>
<h2 id="diagrams-as-code">Diagrams as code:</h2>
<h3 id="mermaid">Mermaid</h3>
<p>Mermaid is a language to generate flow charts, pie charts, entity relation diagrams and several other diagrams. I’ve used it in internal documentation and blog posts. The graph description language is simple enough that you can write code to generate charts, too.</p>
<ul>
<li><a href="https://mermaid-js.github.io/mermaid/#/">https://mermaid-js.github.io/mermaid/#/</a></li>
</ul>
<p>A live editor is also available online:</p>
<ul>
<li><a href="https://mermaid.live/">https://mermaid.live/</a></li>
</ul>
<p>Mermaid rendering has been integrated into several markdown renderers, GitHub markdown and VS Code both support it.</p>
<div class="mermaid">flowchart LR
    a[Airflow] ---> b[AirFlowTask] --> c[[RabbitMQ Queue Events]] --> d[EventReceiver] --insert--> e[(Postgresql)] --> Monitoring
    d --failed--> g[[Deadletter queue]] --> h[Reconciliation] --> e
</div>
<p><img src="/posts/images/SA-Illustrations/Mermaid-flow.png" class="img-fluid" alt="" /></p>
<div class="mermaid">sequenceDiagram
    autonumber

    participant C as Client
    participant S as Target

    S --) C: Communicate API-Key
    C ->> S: Send request with API-Key
    activate S
    S -->> S: Validate API-Key
    S -X C: If not valid: Return 401 
    S ->> C: If valid: Return 200
    deactivate S
</div>
<p><img src="/posts/images/SA-Illustrations/Mermaid-sequence.png" class="img-fluid" alt="" /></p>
<h3 id="python-diagrams">Python Diagrams</h3>
<p>Python has a diagram library which has icons for most programming tools, from Airflow to ZeroMQ. You design the diagram with simple Python code and it uses the Graphviz library to render png images. Highly recommended for small architecture diagrams that just need a dozen or so elements.</p>
<ul>
<li><a href="https://diagrams.mingrammer.com/">https://diagrams.mingrammer.com/</a></li>
</ul>
<p>I’ve also done some pull requests to add symbols to the library and I recommend you do so too if you have elements that are missing in your diagrams.</p>
<pre><code class="language-python">## pip install diagrams
## winget install -e --id Graphviz.Graphviz
## set PATH=C:\Program Files\Graphviz\bin;%PATH%
#
# Architecture of the docker-compose using a chart generated in py

from diagrams import Diagram, Cluster
from diagrams.onprem.inmemory import Redis
from diagrams.onprem.database import Postgresql
from diagrams.onprem.queue import Rabbitmq
from diagrams.programming.language import PHP
from diagrams.programming.language import Csharp
from diagrams.onprem.client import Users
from diagrams.onprem.network import Nginx

with Diagram(&quot;Composed Docker&quot;, show=False):
    users = Users(&quot;users&quot;)
    
    with Cluster(&quot;Front-End&quot;):
        web = Nginx(&quot;ngweb&quot;)
        php = PHP(&quot;php&quot;)

    with Cluster(&quot;Back-Ends&quot;):
        redis = Redis(&quot;cache&quot;)
        rabbit = Rabbitmq(&quot;rabbit&quot;)
        listener = Csharp(&quot;listener&quot;)
        db = Postgresql(&quot;db&quot;)
    
    users &gt;&gt; web &gt;&gt; php &gt;&gt; rabbit &gt;&gt; listener &gt;&gt; db
    php &gt;&gt; redis
</code></pre>
<p><img src="/posts/images/SA-Illustrations/composed_docker.png" class="img-fluid" width="80%" alt="" /></p>
<h3 id="plantuml">PlantUML</h3>
<p>The big one! Plant UML has a ton of diagrams, the language is maybe a bit more obscure and complicated than mermaid, but you gain a lot from PlantUML when you actually need those features.</p>
<ul>
<li><a href="https://plantuml.com/">https://plantuml.com/</a></li>
</ul>
<p>PlantUML also has a live editor online:</p>
<ul>
<li><a href="https://www.plantuml.com/plantuml/uml/">https://www.plantuml.com/plantuml/uml/</a></li>
</ul>
<p>Actually, I’ve used it quite seldomly, being able to cover most requirements with Mermaid and Python Diagrams.</p>
<h2 id="diagrams-as-drawing">Diagrams as Drawing:</h2>
<h3 id="diagrams">Diagrams</h3>
<p>Diagrams.net has both an online and an offline version of a vector drawing software that works exceedingly well for software architecture illustrations. With symbols for most public cloud platforms included in their delectable libraries, you’ll be able to find the right symbol you need.</p>
<ul>
<li><a href="https://www.diagrams.net/">https://www.diagrams.net/</a></li>
</ul>
<p>There’s even a Visual Studio Code extension for editing a diagram inside the IDE. Export can be done to PNG easily. Diagrams produced are easily embedded in Atlassian’s wiki and other wiki products.</p>
<p>Highly recommend if you need to place your architecture elements instead of relying on the auto layout of diagrams as code. Now I just wish that the diagrams as code tools could create a diagram baseline compatible with this tool to modify the layout.</p>
<h3 id="archi-archimate-modelling">Archi (Archimate modelling)</h3>
<p>If you use the <a href="https://en.m.wikipedia.org/wiki/ArchiMate">Archimate modelling language</a>, then this is the tool for you to build your modelling concepts. The formalism is great for making something that everyone can “read” once trained on it, but the investment can be quite high to do the correct modelling of your infrastructure with this tool.</p>
<ul>
<li><a href="https://www.archimatetool.com/">https://www.archimatetool.com/</a></li>
</ul>
<p>I used the Local application running on Windows.</p>
<h4 id="online-architecture-repositories">Online architecture repositories</h4>
<p>There is also online hosted versions of architecture repository tools using Archimate <a href="https://www.boc-group.com/en/adoit/">Adoit EA Suite</a> and an associated community version too.</p>
<p>Alternatively, there's also:</p>
<ul>
<li><a href="https://www.mega.com/hopex-platform">Hopex's MEGA</a> which I only used as it was being decommissioned</li>
<li><a href="https://sparxsystems.com/products/ea/index.html">Sparx Systems’ Enterprise Architect</a> which I used for a short amount of time before the company standardised on Adoit.</li>
</ul>
<h3 id="yed">yEd</h3>
<p>In writing this article, I discovered the tool yEd and wanted to mention it for completeness, I haven't had the opportunity to use it yet. It does mention many of the illustration types that are useful (BPML, Flowcharts, UML, ...).</p>
<ul>
<li><a href="https://www.yworks.com/products/yed">https://www.yworks.com/products/yed</a></li>
</ul>
<h2 id="diagrams-from-programming">Diagrams from programming:</h2>
<p>Now these are more out there and not always directly applicable, but when you need a visualisation that the above tools cannot do, it’s time to break out these applications.</p>
<h3 id="d3js">D3js</h3>
<p>Not sure if I need to introduce D3js,  it is probably one of the most commonly use and important is visualisation libraries. Used in everything from maps to genomics to economic data. It can do it all.</p>
<p><a href="https://d3js.org/">https://d3js.org/</a></p>
<p>I previously used d3js to embed charts of price curves generated from market data, overlapped with the delivery period of energy instruments.</p>
<h3 id="processing.js">Processing.js</h3>
<p>Animated heart pulsating on a field of scintillating gold lace? Yes. That and many more things! Processing excels in the visual demos, animations and more. You’ll have to code it, but it’s no issue to get your custom Mandelbrot animated render and many more. Has interactions with sound and many more features. Does have a high bar of entry though and it takes a while to be productive with it.</p>
<ul>
<li><a href="https://processing.org/">https://processing.org/</a></li>
</ul>
<h3 id="graphviz">Graphviz</h3>
<p>I would be remiss if I didn’t mention Graphviz. It is the library used to generate diagrams from textual descriptions using one of their many languages, Dot being one of them.</p>
<p>Not something I use directly but more indirect usages via the Python diagrams library. You can learn it’s language and create charts.</p>
<ul>
<li><a href="https://graphviz.org/">https://graphviz.org/</a></li>
</ul>
<h2 id="online-services-collaborative">Online services (collaborative)</h2>
<p>When you need online collaboration, which the tools above do not cover, you can turn to the following services.</p>
<h3 id="miro">Miro</h3>
<p>I’ve had the most experience with Miro while running large organisation meetings as a place to collect ideas, do feedback rounds and generally plan activities.</p>
<ul>
<li><a href="https://miro.com">https://miro.com</a></li>
</ul>
<h3 id="lucidspark-lucidchart-and-lucidscale">LucidSpark, LucidChart and LucidScale</h3>
<p>Both collaboration and vector illustration online software. Also their ability with lucid scale to connect and document your cloud infrastructure is very impressive and helps to keep you infrastructure maps updated.</p>
<ul>
<li><a href="https://www.lucidspark.com/">https://www.lucidspark.com/</a></li>
<li><a href="https://www.lucidscale.com/">https://www.lucidscale.com/</a></li>
<li><a href="https://www.lucidchart.com/">https://www.lucidchart.com/</a></li>
</ul>
<p>Sadly, it’s one that I’ve not had the opportunity to use very often, usually because it was covered by other tools and no one else in the company was using it. But you should check it out to see if it does work for you and your team.</p>
<h3 id="microsoft-whiteboard">Microsoft Whiteboard</h3>
<p>When all else fails, there’s Microsoft whiteboard. It works, there’s an online version, an integration in teams, a desktop app and even an iOS / iPadOS application. More suited to drawing with a pen, then it becomes a great collaborative whiteboard. I have given internal talks using a Microsoft Whiteboard as a backdrop. I really like to start small and progressively zoom out on these massive canvases.</p>
<p><a href="https://www.microsoft.com/en-us/microsoft-365/microsoft-whiteboard/digital-whiteboard-app">https://www.microsoft.com/en-us/microsoft-365/microsoft-whiteboard/digital-whiteboard-app</a></p>
<h2 id="mind-maps">Mind maps</h2>
<p>I don't use mind maps very often anymore. I was taught to use them as a child, but haven't kept up the practice. I'm just adding a couple of references in case you are looking for them:</p>
<h3 id="vscode-mindmap">vscode-mindmap</h3>
<p>I've used vscode-mindmap when I needed to create a quick hierarchy map.</p>
<ul>
<li><a href="https://marketplace.visualstudio.com/items?itemName=pmcxs.vscode-mindmap">https://marketplace.visualstudio.com/items?itemName=pmcxs.vscode-mindmap</a></li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>There’s no one tool for everything in this day and age. Use what works for you and try out several to see if they stick!</p>
<p>I highly recommend generating some charts in mermaid from your own database ER-Diagram (easy to do!) or using it to make pie charts like <a href="https://youtu.be/IXRGa5m-Lbo">Microsoft Polyglot notebooks demonstrates at 15:05 onwards</a> in their <a href="https://github.com/dotnet/interactive/blob/main/samples/notebooks/polyglot/github%20repo%20milestone%20report.ipynb">GitHub demo notebook</a>.</p>
<p>If you have other recommendations for me, do feel free to reach out and I’ll see if they make to cut to get added to this list. :) You can even pull request this actual blog post on GitHub.</p>
<p>Finally, if someone has a recommendation for a WAN/LAN topology visualisation or charting tool, I’d be happy to hear about it and your experience with it!</p>
						<hr>
                </div>       
                <div>
                    <a href="/posts/Data-Lineage">
                        <h2>Data Lineage for dataflow and workflow processes</h2>
                    </a>
                    <p>Posted on Saturday, 12 November 2022</p>
<h1 id="data-lineage">Data lineage</h1>
<p>When working with large amounts of data, extraction, transforms and loads procedures can hide the source of the original data and make inquiries on &quot;where did this data come from and what happened to it?&quot; difficult to answer.</p>
<p>A data lineage is &quot;the process of understanding, recording, and visualizing data as it flows from data sources to consumption<a id="fnref:1" href="#fn:1" class="footnote-ref"><sup>1</sup></a>&quot; and tries to answer that question.</p>
<p>Using dataflow and ETL orchestration tools such as <a href="https://airflow.apache.org/">Airflow</a>, <a href="https://www.prefect.io">Prefect</a>, <a href="https://nifi.apache.org/">NiFi</a>, we move and transform data, but also lose the reference as to how the data was transformed.</p>
<p>In this document, we will approach one open source tool OpenLineage and one &quot;hand built&quot; approach to capturing and storing data lineage information.</p>
<h1 id="openlineage-and-marquez-open-source-tools">OpenLineage and Marquez - Open source tools</h1>
<p><a href="https://openlineage.io/">OpenLineage</a> is an open source project and framework for data lineage collection and analysis that helps collect lineage metadata from the data  processing applications. At its core, OpenLineage exposes a standard API for metadata collection - a single API call: <a href="https://openlineage.io/apidocs/openapi/"><strong>postRunEvent</strong></a>.</p>
<p>To simplify its implementation with AirFlow, Open Lineage has an <a href="https://github.com/OpenLineage/OpenLineage/tree/main/integration/airflow/openlineage/airflow">airflow connection module</a> already available.</p>
<p>On the back-end, the storage of run meta-data has a reference implementation named Marquez. The data model is illustrated here.</p>
<p><a href="https://lucid.app/lucidchart/f918ce01-9eb4-4900-b266-49935da271b8/view?page=8xAE.zxyknLQ#">Marquez data model</a></p>
<p><img src="/posts/images/data-lineage/Marquez-Data-Model.png" class="img-fluid" width="80%" alt="" /></p>
<p>But it is also possible to implement one's own storage for metadata in case there is a need or added value, but adopting the open source solution will be an advantage for integration later.</p>
<h1 id="locally-grown-alternatives">Locally grown alternatives</h1>
<p>Data correlation and lineage information can be generated via the emission of events while processing input data. Additionally, input data can be fingerprinted via a fast hash function to check for duplicate imports, so as to enable idempotent processing.</p>
<h3 id="input-dataset-fingerprinting-via-non-cryptographic-hash-function">Input dataset fingerprinting via non-cryptographic hash function</h3>
<p>We can use a fast non-cryptographic hash function such as <a href="https://github.com/backtrace-labs/umash">umash</a> to generate a hash of the input data or xxhash <code>sudo apt-get install xxhash</code>. xxhash is capable of taking streaming STDIN data from compressed files to generate a fast hash.</p>
<pre><code class="language-bash">time gunzip -c /mnt/d/smart_meter_data/ckw_opendata_smartmeter_dataset_a_202101.csv.gz | /usr/bin/xxhsum
</code></pre>
<h3 id="correlation-ids-with-uuids">Correlation IDs with UUIDs</h3>
<p>Generating uuid for correlations identifiers along <a href="https://www.rfc-editor.org/rfc/rfc4122.html">rfc4122</a> gives us multiple variant generation algorithms to give us sortable UUIDs which minimize collision possibilities even with a high UUID generation rate.</p>
<h3 id="hierarchical-correlation-ids-using-closure-tables">Hierarchical correlation IDs using closure tables</h3>
<p>When inputs contain a dataset that is composed of multiple data points that identify unique sets in our final processed dataset, it becomes necessary to be able to trace their lineage back to the initial input. A recursive search through a table of entries to find the parent correlation identifier of a child time-series is quite inefficient.</p>
<p>To have fast search over deep hierarchies of correlations IDs in relational databases, we can turn to the concept of closure tables.</p>
<table class="table">
<thead>
<tr>
<th style="text-align: left;">Field</th>
<th style="text-align: left;">Type</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">ParentId</td>
<td style="text-align: left;">UUID</td>
</tr>
<tr>
<td style="text-align: left;">ChildId</td>
<td style="text-align: left;">UUID</td>
</tr>
<tr>
<td style="text-align: left;">Depth</td>
<td style="text-align: left;">integer</td>
</tr>
</tbody>
</table>
<p>This table structure allows to query in one query all parent or children of an identifier in one non-recursive sql query. This is done at the cost of having to insert the entire hierarchy of the correlationIDs upon insertion.</p>
<p>Here we are representing the two hierarchies</p>
<pre><code>aaa &gt; bbb &gt; ccc
aaa &gt; eee 
</code></pre>
<table class="table">
<thead>
<tr>
<th style="text-align: left;">ParentId</th>
<th style="text-align: left;">ChildId</th>
<th style="text-align: right;">Depth</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">aaa</td>
<td style="text-align: left;">aaa</td>
<td style="text-align: right;">0</td>
</tr>
<tr>
<td style="text-align: left;">bbb</td>
<td style="text-align: left;">bbb</td>
<td style="text-align: right;">0</td>
</tr>
<tr>
<td style="text-align: left;">ccc</td>
<td style="text-align: left;">ccc</td>
<td style="text-align: right;">0</td>
</tr>
<tr>
<td style="text-align: left;">eee</td>
<td style="text-align: left;">eee</td>
<td style="text-align: right;">0</td>
</tr>
<tr>
<td style="text-align: left;">aaa</td>
<td style="text-align: left;">bbb</td>
<td style="text-align: right;">1</td>
</tr>
<tr>
<td style="text-align: left;">bbb</td>
<td style="text-align: left;">ccc</td>
<td style="text-align: right;">1</td>
</tr>
<tr>
<td style="text-align: left;">aaa</td>
<td style="text-align: left;">ccc</td>
<td style="text-align: right;">2</td>
</tr>
<tr>
<td style="text-align: left;">aaa</td>
<td style="text-align: left;">eee</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
<p><em>note</em>: <em>if desired the initial 0 depth nodes can be neglected from the insertion process without losing functionality, but can be useful in certain modeling processes (eg. rights, groups)</em></p>
<p>If we need to find all children of <strong>aaa</strong>, we can do a</p>
<pre><code>SELECT ChildId, Depth FROM Closure_Table WHERE ParentId = &quot;aaa&quot; ORDER BY Depth;
</code></pre>
<p>which returns the following</p>
<table class="table">
<thead>
<tr>
<th style="text-align: left;">ChildId</th>
<th style="text-align: left;">Depth</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">aaa</td>
<td style="text-align: left;">0</td>
</tr>
<tr>
<td style="text-align: left;">bbb</td>
<td style="text-align: left;">1</td>
</tr>
<tr>
<td style="text-align: left;">eee</td>
<td style="text-align: left;">1</td>
</tr>
<tr>
<td style="text-align: left;">ccc</td>
<td style="text-align: left;">2</td>
</tr>
</tbody>
</table>
<p>If we need to find all parents of <strong>eee</strong>, we can do a</p>
<pre><code>SELECT ParentId, Depth FROM Closure_Table WHERE ChildId = &quot;eee&quot; ORDER BY Depth DESC;
</code></pre>
<p>which returns the following</p>
<table class="table">
<thead>
<tr>
<th style="text-align: left;">ParentId</th>
<th style="text-align: left;">Depth</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">aaa</td>
<td style="text-align: left;">1</td>
</tr>
<tr>
<td style="text-align: left;">eee</td>
<td style="text-align: left;">0</td>
</tr>
</tbody>
</table>
<h3 id="table-structure-for-a-correlated-fingerprinted-hierarchical-data-lineage">Table structure for a Correlated, fingerprinted hierarchical data lineage</h3>
<p>With correlatedEvent and CorrelatedLineage tables, it becomes possible in a single request to generate a lineage graph for parents or descendants of correlated dataset.</p>
<p><img src="/posts/images/data-lineage/CorrelatedLineageDataModel.png" class="img-fluid" alt="" /></p>
<pre><code>erDiagram
    CorrelationEvent {
        uuid     IdEvent
        string   Process
        string   Version
        hash     Fingerprint
        int      InputSize
        datetime EventTime
        int      Forced
    }

    CorrelationDetails {
        uuid IdEvent
        string Field
        json Data 
    }

    CorrelationLineage {
        uuid IdParent
        uuid IdChild
        integer Depth
    }

    CorrelationEvent ||--o{ CorrelationDetails : &quot;&quot;
    CorrelationEvent ||--o{ CorrelationLineage : &quot;parent&quot;
    CorrelationEvent ||--o{ CorrelationLineage : &quot;child&quot;
</code></pre>
<p>It would even be possible to generate the diagrams using mermaid automatically to trace the flows through the system<a id="fnref:2" href="#fn:2" class="footnote-ref"><sup>2</sup></a>.</p>
<p><img src="/posts/images/data-lineage/CorrelatedLineageFlow.png" class="img-fluid" alt="" /></p>
<pre><code>flowchart LR
    id1((&quot;DSO Timeseries&quot;)) --&gt; id2[SFTP Download] --&gt; id3[Split]
    id3 --&gt; TS01
    id3 --&gt; TS02
    id3 --&gt; TS03 
    id3 --&gt; TS04
    id3 --&gt; TS..
    TS01 --&gt; id4[Delivery point sum]
    TS02 --&gt; id4
    id4 --&gt; id5[Load]

    met((Weather provider)) --&gt; met2[API Download] --&gt; met3[&quot;Aggregate to hour&quot;] --&gt; met4[&quot;delivery point history&quot;]

    met4 --&gt; for1[forecast consumption]
    id4 --&gt; for1 --&gt; for2[Load]
</code></pre>
<h3 id="solution-design">Solution design</h3>
<p>A rabbitMQ message queue to receive correlation events emitted by the tasks, with several consumer tasks receiving and committing to the database is a preferred approach over an HTTP 1.1 connection due the the scaling efficiency of AMQP over pure HTTP<a id="fnref:3" href="#fn:3" class="footnote-ref"><sup>3</sup></a>.</p>
<p><img src="/posts/images/data-lineage/CorrelatedApplicationFlow.png" class="img-fluid" width="80%" alt="" /></p>
<pre><code>flowchart LR
    a[Airflow] ---&gt; b[AirFlowTask] --&gt; c[[RabbitMQ Queue Events]] --&gt; d[EventReceiver] -- success --&gt; g[(Postgresql)] --&gt; Monitoring
    d -- failed --&gt; e[[RabbitMQ Queue Deadletter]] --&gt; f[DLQ processing and Reconciliation] --&gt; g
</code></pre>
<p>A particular focus on the monitoring of the solution is necessary to truly have an operational system. The RabbitMQ should be a redundant, instrumented and reported to Graphana, with a queue length monitoring in place. The EventReceivers should employ a dead letter queue in case message are rejected by the database. These rejected messages could also also be a uuid collision - which can be treated by the daily reconciliation process and DeadLetter queue processing.</p>
<p>A high availability Postgresql is recommended, either as a local instance or as a cloud hosted service - which would facilitate operations.</p>
<p>The issue of Data retention should be discussed with Business. If we do not keep a time-series history in the time-series datastore, then the event correlation become actually an <a href="https://microservices.io/patterns/data/event-sourcing.html">event sourcing pattern</a>, enabling to re-create the history of how the time-series was updated.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Irrespective of the method chosen to capture and store the messages, the systems chosen must provide a high availability solution for data lineage - but must be sure to not block ingestion if the data lineage system is unresponsive. As long as the message queue is persistent and accessible, it can always be caught up later.</p>
<p>The main task is emitting the events with meaningful data and unique correlation IDs. A focus on the semantics of the events while developing the workflow / dataflows is primordial. A callable event library provides the best developer experience to maximize standardization of code</p>
<p>The design of idempotent imports into the system is important, it allows to replay events non-destructively and provides operational resilience.</p>
<div class="footnotes">
<hr />
<ol>
<li id="fn:1">
<p><a href="https://www.imperva.com/learn/data-security/data-lineage/">https://www.imperva.com/learn/data-security/data-lineage/</a><a href="#fnref:1" class="footnote-back-ref">&#8617;</a></p>
</li>
<li id="fn:2">
<p><a href="https://github.com/dotnet/interactive/blob/main/samples/notebooks/polyglot/github%20repo%20milestone%20report.ipynb">https://github.com/dotnet/interactive/blob/main/samples/notebooks/polyglot/github%20repo%20milestone%20report.ipynb</a> - See the PieWithMermaid C# task for a visualisation of such an interaction.<a href="#fnref:2" class="footnote-back-ref">&#8617;</a></p>
</li>
<li id="fn:3">
<p>This should be re-evaluated when HTTP/3 oneshot becomes available in the servers and languages used. The expected performance improvement are such that at that time HTTP/3 QUIC might outrace any other streaming solution. <a href="https://blog.cloudflare.com/http3-the-past-present-and-future/">https://blog.cloudflare.com/http3-the-past-present-and-future/</a><a href="#fnref:3" class="footnote-back-ref">&#8617;</a></p>
</li>
</ol>
</div>
						<hr>
                </div>       
                <div>
                    <a href="/posts/tesla-megapack">
                        <h2>Tesla Megapacks put into context</h2>
                    </a>
                    <p>Posted on Wednesday, 9 November 2022</p>
<h1 id="tesla-megapacks">Tesla Megapacks</h1>
<p>Tesla on Twitter announced: <a href="https://t.co/aw85eHECXI">&quot;Meet Megafactory, our new Megapack factory in Lathrop, CA 🔋🔋🔋&quot;</a></p>
<p>Tesla's energy division has recently completed their new Megapack factory in Lathrop California , which they claim can produce currently 10'000 Megapacks a year. How much storage is that and how does this compare to a Hydropower pump storage plant?</p>
<h2 id="tesla-megapacks-specs-per-pack">Tesla megapacks Specs per pack</h2>
<ul>
<li>4 Hour Duration</li>
<li>Power: 970 kW</li>
<li>Energy: 3,916 kWh per Megapack</li>
<li>Round Trip Efficiency: 93.5%</li>
<li>9.12 m x 1.65 m x 2.79 m</li>
<li>38,100 kg</li>
<li>~$2 million per pack</li>
</ul>
<h2 id="offer">Offer</h2>
<p>An offer was generated on the Tesla Energy website to get an appropriate pricing for the largest system they offer.</p>
<ul>
<li>1000 Megapack</li>
<li>969.6 MW Power</li>
<li>3916 MWh Energy Megapack</li>
<li>Duration: 4 Hours</li>
<li>Delivery: Q3 2024</li>
<li>Estimated Price (California) $1,832,519,850</li>
<li>Est. Annual Maintenance $4,821,480 - Maintenance Price escalates at 2% per year</li>
</ul>
<p>Based on this, we can see that 10'000 megapacks represent about 39160 MWh of storage (39 GWh), with a sales cost of approx $18 billion.</p>
<p>So how does this compare to the two latest large Swiss Pump-Storage Hydropowerplants?</p>
<h2 id="hydropower-plants">Hydropower plants</h2>
<h3 id="nant-de-drance-pump-storage-extension">Nant-de-Drance pump-storage extension</h3>
<ul>
<li>1 Pump-storage power plant</li>
<li>Power 900 MW (Turbines and Pumps)</li>
<li>Storage 20 GWh</li>
<li>Duration: 19 Hours</li>
<li>Round trip efficiency: over 90%</li>
<li>Estimated Price 2 billion CHF</li>
<li>~14 years to build and bring into operation</li>
</ul>
<h3 id="kraftwerk-linthlimmern-pump-storage-extension">Kraftwerk-Linth–Limmern pump-storage extension</h3>
<ul>
<li>1 Pump-storage power plant</li>
<li>Power 1000 MW (Turbines and Pumps)</li>
<li>Storage 33 GWh</li>
<li>Duration: 33 Hours</li>
<li>Round trip efficiency: over 90%</li>
<li>Estimated Price 2.1 billion CHF</li>
<li>~10 years to build and bring into operation</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>The storage cost of the batteries is currently about a factor 4-9x the price of the hydropower plant construction but have the advantage of being available within about 18 months. What remains to be seen is how much battery degradation is a factor in these grid scale battery installations. At least Tesla is offering, from my understanding, a 15 year warranty on the Megapack.</p>
<p>The amount of storage produced by the factory represents more than 1 large hydropower plant per year.</p>
<p>The 39 GWh storage produced by the factory in one year is a huge amount, so much that it would cover around 25% of the <a href="https://www.iea.org/data-and-statistics/charts/battery-storage-capability-by-countries-2020-and-2026">expected total capacity that the IEA planned for the entire world by 2026</a>.</p>
<h2 id="post-scriptum-new-gridscale-batteries-in-europe">Post-scriptum: new gridscale batteries in Europe</h2>
<p>2022.11.22 - <a href="https://www.bbc.com/news/uk-england-humber-63707463">Cottingham: Europe's biggest battery storage system switched on - 196MWh</a></p>
<ul>
<li>Power: ? (my estimate ~50-100 MW)</li>
<li>Storage: 196 MWh</li>
<li>use Tesla's AI software to match energy supply to demand</li>
<li>Commissioning in two stages in December 2022 and March 2023.</li>
<li>Supplier: Tesla</li>
<li>Cost: ? (my estimate $100 million+)</li>
</ul>
<p>As usual, BBC is terribly uninformative about specifications and cost. If we assume 50 Tesla Megapacks, cost should be around $100 million+ and 50 to 100 MW based on the 2h or 4h megapacks. Interesting to see a Tesla system in Europe. I expect many more to come online.</p>
<p>2022.11.07 - <a href="https://www.rwe.com/en/press/rwe-generation/2022-11-07-battery-storage-220-mw-neurath">RWE gives green light for 220-megawatt battery storage system in North Rhine-Westphalia</a></p>
<ul>
<li>Power: 80 + 140 MW = 220 MW</li>
<li>Storage: delivering the required output for over an hour but full capacity not mentioned. 220 MWh to 440MWh.</li>
<li>140 million euros</li>
<li>commissioning in 2024</li>
<li>Supplier: Not mentioned.</li>
</ul>
<p>2021.07.22 - <a href="https://www.rwe.com/en/press/rwe-ag/2021-07-22-rwe-builds-one-of-the-largest-battery-storage-facilities-in-germany">RWE bringing 72MW BESS in Germany online in November</a></p>
<ul>
<li>Power: 72 + 45MW = 117 MW</li>
<li>Storage: 128MWh</li>
<li>€50 million</li>
<li>commissioning in end 2022</li>
<li>Supplier: CATL batteries</li>
</ul>
						<hr>
                </div>       
                <div>
                    <a href="/posts/sqlite-microstores">
                        <h2>Embracing SQLite and living with micro-services</h2>
                    </a>
                    <p>Posted on Saturday, 22 October 2022</p>
<p>The idea of micro-services and their own single purpose data stores is easy to describe. But then to implement and live with it is a different story. So as a developer and architect, I’ve decided to do just that! Make micro-services and micro-data stores to cover the tiny and small stuff in my life I want to keep track of.</p>
<p>As an example, I read online comics, light novels and mangas. I had a continuous list of a couple hundred bookmarks that I tried to keep updated with the last position I was when I read the story. But I always forget to update the bookmark and have so many of them that I lose the last read chapter. My solution?</p>
<p>A SQLite db and some Python code to load it. Pass a single url on some command line Python and it gets added to the Db, a Request goes out, gets the title and chapter from the html, then adds it to the DB by title. Now I have a track of where I left off and I can get have last updated / last read records. Bonus, I can do a SELECT .. ORDER BY updated LIMIT 10 to check the last stories I was reading and pipe them to my browser to open up the chapters where I left them off.</p>
<p>To really embrace SQLite is to make everything in your life become a new micro database, even if there's only a couple of tables with a dozen or a hundred rows.</p>
<p>Stock tracking? an SQLite Db with Transactions and a roll-up Inventory table.</p>
<p>In fact, even when sending data around from one system to another, we should even embrace the simplicity of SQLite over CSV files. See <a href="https://berthub.eu/articles/posts/big-data-storage/">https://berthub.eu/articles/posts/big-data-storage/</a> for his views and performance tests.</p>
<p>Now I have micro data-stores, I can add a service on top which contains the CRUD commands I need to interact with them and show them in a personal dashboard.</p>
						<hr>
                </div>       
        <ul class="pager">
            <li class="previous">                
            </li>
            <li class="next">
            </li>
        </ul>
    </div>
    <div class="4u 12u$(medium)">

            <h5>Tags</h5>
            <ul class="actions small">
                    <li><a role="button" href="/tags/Migrated" class="button small">Migrated (38)</a></li>
                    <li><a role="button" href="/tags/Database" class="button small">Database (10)</a></li>
                    <li><a role="button" href="/tags/Thoughts" class="button small">Thoughts (9)</a></li>
                    <li><a role="button" href="/tags/CSharp" class="button small">CSharp (8)</a></li>
                    <li><a role="button" href="/tags/Jupyter-notebook" class="button small">Jupyter notebook (7)</a></li>
                    <li><a role="button" href="/tags/Dotnet-try" class="button small">Dotnet try (7)</a></li>
                    <li><a role="button" href="/tags/Oracle" class="button small">Oracle (6)</a></li>
                    <li><a role="button" href="/tags/WPF" class="button small">WPF (4)</a></li>
                    <li><a role="button" href="/tags/Rpi" class="button small">Rpi (4)</a></li>
                    <li><a role="button" href="/tags/Space" class="button small">Space (4)</a></li>
            </ul>
            <ul class="actions small">
                <li><a href="/tags" class="button small">View All Tags &rarr;</a></li>
            </ul>    

            <h5>Older Posts</h5>
            <ul>
                    <li><a href="/posts/Starship-laser-ablation">The case for a SpaceX Starship laser ablation platform for orbital debris management</a></li>
                    <li><a href="/posts/Viruses-left-behind">We can leave viruses behind on Earth as we leave the gravity well</a></li>
                    <li><a href="/posts/db-health">Checking for liveness on databases for health checks</a></li>
                    <li><a href="/posts/Point-of-exporing-space">The point of Space exploration</a></li>
            </ul>
                <ul class="actions small">
                    <li><a href="/posts" class="button small">Archive &rarr;</a></li>
                </ul>

        
    </div> 
</div>
					</div>
				</div>
			</div>

			<!-- Footer -->
			<footer id="footer">
				<div class="inner">
    <section>
        <h2>Feeds</h2>
        <ul class="actions small vertical">
            <li><a href="/feed.rss" class="button small"><i class="fa fa-rss"></i> RSS Feed</a></li>
                        <li><a href="/feed.atom" class="button small"><i class="fa fa-rss"></i> Atom Feed</a></li>
        </ul>
    </section>
    <section>
    </section>
    <ul class="copyright">
        <li>Copyright © 2022</li>
        <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
        <li><a href="https://wyam.io">Generated by Wyam</a></li>
    </ul>
</div>

			</footer>

		</div>
		
		

		<!-- Scripts -->
		<script>hljs.initHighlightingOnLoad();</script>
		<script src="/assets/js/jquery.min.js"></script>
		<script src="/assets/js/skel.min.js"></script>
		<script src="/assets/js/util.js"></script>
		<!--[if lte IE 8]><script src="/assets/js/ie/respond.min.js"></script><![endif]-->
		<script src="/assets/js/main.js"></script>

	</body>

</html>
