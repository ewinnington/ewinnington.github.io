
<!DOCTYPE html>
<!--
	Phantom by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html lang="en">

	<head>
		<title>Eric Winnington</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />		
        <link href="/assets/css/highlight.css" rel="stylesheet">
		<!--[if lte IE 8]><script src="/assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="/assets/css/main.css" />
		<!--[if lte IE 9]><link rel="stylesheet" href="/assets/css/ie9.css" /><![endif]-->
		<!--[if lte IE 8]><link rel="stylesheet" href="/assets/css/ie8.css" /><![endif]-->
        <link href="/assets/css/override.css" rel="stylesheet" />

		<meta name="description" content="A collection of thoughts, code and snippets." />
		<link type="application/rss+xml" rel="alternate" title="Eric Winnington" href="/feed.rss" />
				<link type="application/atom+xml" rel="alternate" title="Eric Winnington" href="/feed.atom" />
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="icon" href="/favicon.ico" type="image/x-icon">

		<meta name="application-name" content="Eric Winnington" />
		<meta name="msapplication-tooltip" content="Eric Winnington" />
		<meta name="msapplication-starturl" content="/" />

		<meta property="og:title" content="Eric Winnington" /> 
		<meta property="og:type" content="website" />
		<meta property="og:url" content="http://ewinnington.github.io/" />
		<!-- TODO: More social graph meta tags -->

        <script src="/assets/js/highlight.pack.js"></script>   
		
        <meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@ewinnington" />
<meta name="twitter:title" content="Eric Winnington" />
<meta name="twitter:description" content="A collection of thoughts, code and snippets." />

<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
		
	</head>

	<body>
		<!-- Wrapper -->
		<div id="wrapper">

			<!-- Header -->
			<header id="header">
				<div class="inner">

					<!-- Logo -->
					<a href="/" class="logo">
						<span class="title">Eric Winnington</span>
					</a>

					<!-- Nav -->
					<nav>
						<ul>
							<li><a href="#menu">Menu</a></li>
						</ul>
					</nav>

				</div>
			</header>

			<!-- Menu -->
			<nav id="menu">
				<h2>Menu</h2>
				<ul>
					        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About Me</a></li>
        <li><a href="/videos">Videos on programming</a></li>

				</ul>
			</nav>

			<!-- Main -->
			<div id="main">
				<div class="inner">

    <header>
        <h1>A collection of thoughts, code and snippets.</h1>
    </header>

					
					<div id="content">
						
<div class="row">
    <div class="8u 12u$(medium)">
                <div>
                    <a href="/posts/omarchy-hdmi-audio">
                        <h2>Omarchy - Multi-monitor HDMI and Audio</h2>
                    </a>
                    <p>Posted on Thursday, 16 October 2025</p>
<h1 id="configuring-multi-monitor-and-choosing-hdmi-sound-output-in-omarchy">Configuring multi-monitor and choosing HDMI sound output in Omarchy</h1>
<p>I added a vertical monitor to my Omarchy desk. I have my BenQ horitontal and have added a Samsung as a vertical screen on the side.</p>
<h2 id="video-setup">Video setup</h2>
<p>Listing my monitors gives me the following:</p>
<pre><code class="language-bash">hyprctl monitors

Monitor HDMI-A-1 (ID 0):
	3840x2160&#64;60.00000 at 0x0
	description: Samsung Electric Company LS27A800U HNMW500048
	make: Samsung Electric Company
	model: LS27A800U
	physical size (mm): 600x340
	serial: -----------
	active workspace: 1 (1)
	special workspace: 0 ()
	reserved: 0 26 0 0
	scale: 1.50
	transform: 1
	focused: yes
	dpmsStatus: 1
	vrr: false
	solitary: 0
	solitaryBlockedBy: windowed mode,missing candidate
	activelyTearing: false
	tearingBlockedBy: next frame is not torn,user settings,missing candidate
	directScanoutTo: 0
	directScanoutBlockedBy: user settings,missing candidate
	disabled: false
	currentFormat: XRGB8888
	mirrorOf: none
	availableModes: 3840x2160&#64;60.00Hz ...

Monitor HDMI-A-2 (ID 1):
	3840x2160&#64;60.00100 at -2560x0
	description: BNQ BenQ EL2870U TBK01026SL0
	make: BNQ
	model: BenQ EL2870U
	physical size (mm): 620x340
	serial: -----------
	active workspace: 2 (2)
	special workspace: 0 ()
	reserved: 0 26 0 0
	scale: 1.50
	transform: 0
	focused: no
	dpmsStatus: 1
	vrr: false
	solitary: 0
	solitaryBlockedBy: not opaque
	activelyTearin#pactl list short sinks
#pactl list cardsg: false
	tearingBlockedBy: next frame is not torn,user settings,missing candidate
	directScanoutTo: 0
	directScanoutBlockedBy: user settings,missing candidate
	disabled: false
	currentFormat: XRGB8888
	mirrorOf: none
	availableModes: 3840x2160&#64;60.00Hz ...

</code></pre>
<p>I edited the monitors file to have <code>~/.config/hypr/monitors.conf</code></p>
<pre><code class="language-bash">monitor=HDMI-A-2,preferred,auto-left,1.5
monitor=HDMI-A-1,preferred,auto-right,1.5, transform, 1
</code></pre>
<p>so that the A-1 (Samsung) has the vertical transform. I might switch it to -1 and turn the monitor the other way, because I have less of a bezel on the top of the monitor, but this is the current setup. I'm still not sure which auto- command I need at minimum, but with these two commands - the screens align the way I want.</p>
<h2 id="audio-setup">Audio setup</h2>
<p>The next issue I have is that the audio output is connected from the back of the BenQ monitor to my speaker system, taking the audio along the HDMI channel. Sometimes, depending on which order the screens wake up, the audio output  switches to the Samsung. For the moment, I haven't yet fully figured out how to lock the audio output to a single HDMI output, so I have two scripts to run - checking which outputs where. I'll appreciate the help if someone has suggestions.</p>
<p>I used these commands to list the cards and outputs:</p>
<pre><code>pactl list short sinks
pactl list cards
</code></pre>
<p>And depending on which screen woke up first, it's either running this one:</p>
<pre><code>pactl set-card-profile alsa_card.pci-0000_00_1f.3 output:hdmi-stereo-extra1
pactl set-default-sink alsa_output.pci-0000_00_1f.3.hdmi-stereo-extra1
</code></pre>
<p>or this one:</p>
<pre><code>pactl set-card-profile alsa_card.pci-0000_00_1f.3 output:hdmi-stereo
pactl set-default-sink alsa_output.pci-0000_00_1f.3.hdmi-stereo
</code></pre>
<p>I'm hoping to figure out how to pin the audio to the BenQ monitor soon.</p>
						<hr>
                </div>       
                <div>
                    <a href="/posts/omarchy-brightness2">
                        <h2>Omarchy - Integrating screen brightness via key binds</h2>
                    </a>
                    <p>Posted on Wednesday, 10 September 2025</p>
<h1 id="controlling-external-monitor-brightness-ddcci-in-hyprland-with-a-real-osd">Controlling External Monitor Brightness (DDC/CI) in Hyprland with a Real OSD</h1>
<p>As a follow-up to the previous entry on how to get the <a href="https://ewinnington.github.io/posts/omarchy-brightness">brightness adapted by ddcutil</a>, I actually asked <a href="https://openai.com/codex/">OpenAI's Codex</a> to wire it up in my keyboard bindings. Once it succeeded and get the osd wired up, I asked it to document the process. Here is the Codex generated documentation.</p>
<p>As a side note I created a small script to increase or decrease the brightness on the command line, that is executable.</p>
<pre><code class="language-bash">#!/bin/bash
# brightness up/down script using ddcutil
STEP=10
case &quot;$1&quot; in
  up)   ddcutil setvcp 10 +$STEP ;;
  down) ddcutil setvcp 10 -$STEP ;;
  get)  ddcutil getvcp 10 ;;
  *)    echo &quot;Usage: $0 {up|down|get}&quot; ;;
esac
</code></pre>
<h1 id="openai-codex-steps-and-explanations">OpenAI Codex steps and explanations</h1>
<ul>
<li>Environment: Hyprland (Omarchy on Arch), SwayOSD, ddcutil</li>
<li>Goal: Make hardware brightness keys and Alt+F1/F2 control HDMI monitor brightness via DDC/CI, with a correct on-screen display (OSD).</li>
</ul>
<h2 id="the-problem">The Problem</h2>
<ul>
<li>Omarchy’s default media bindings show the OSD and call brightnessctl, which targets laptop backlights—not external HDMI displays.</li>
<li>My script ~/bin/hdmi-brightness already adjusts HDMI brightness using ddcutil, but Hyprland wasn’t calling it from brightness keys.</li>
<li>Bonus ask: show an OSD reflecting the real HDMI brightness level.</li>
</ul>
<h2 id="solution-summary">Solution Summary</h2>
<ul>
<li>Unbind default brightness keys.</li>
<li>Bind brightness keys and Alt+F1/F2 to the hdmi-brightness script.</li>
<li>After each adjustment, read the real brightness via ddcutil getvcp 10 and display an OSD using SwayOSD’s custom-progress mode.</li>
</ul>
<h2 id="keybindings">Keybindings</h2>
<ul>
<li>File: ~/.config/hypr/bindings.conf</li>
<li>Unbind defaults:
<ul>
<li>unbind = , XF86MonBrightnessUp</li>
<li>unbind = , XF86MonBrightnessDown</li>
<li>unbind = ALT, XF86MonBrightnessUp</li>
<li>unbind = ALT, XF86MonBrightnessDown</li>
</ul>
</li>
<li>Bind to DDC/CI script + OSD:
<ul>
<li><code>bindeld = , XF86MonBrightnessUp, HDMI Brightness up, exec, bash -lc &quot;~/bin/hdmi-brightness raise; read P R &lt;&lt;&lt; $(ddcutil getvcp 10 2&gt;/dev/null | awk 'BEGIN{FS=\&quot;[=,]\&quot;} /current value/ {cv=$2+0; mv=$4+0; if(mv&lt;=0){p=0;r=0}else{p=int((cv*100+mv/2)/mv); r=cv/mv}; if(r&lt;0) r=0; if(r&gt;1) r=1; printf(\&quot;%d %.2f\&quot;, p, r)}'); $osdclient --custom-icon display-brightness --custom-progress-text \&quot;Brightness: $P%\&quot; --custom-progress \&quot;$R\&quot;&quot;</code></li>
<li><code>bindeld = , XF86MonBrightnessDown, HDMI Brightness down, exec, bash -lc &quot;~/bin/hdmi-brightness lower; read P R &lt;&lt;&lt; $(ddcutil getvcp 10 2&gt;/dev/null | awk 'BEGIN{FS=\&quot;[=,]\&quot;} /current value/ {cv=$2+0; mv=$4+0; if(mv&lt;=0){p=0;r=0}else{p=int((cv*100+mv/2)/mv); r=cv/mv}; if(r&lt;0) r=0; if(r&gt;1) r=1; printf(\&quot;%d %.2f\&quot;, p, r)}'); $osdclient --custom-icon display-brightness --custom-progress-text \&quot;Brightness: $P%\&quot; --custom-progress \&quot;$R\&quot;&quot;</code></li>
<li><code>bindeld = ALT, F2, HDMI Brightness up, exec, [same as above with raise]</code></li>
<li><code>bindeld = ALT, F1, HDMI Brightness down, exec, [same as above with lower]</code></li>
</ul>
</li>
<li>$osdclient comes from Omarchy’s defaults and shows OSD on the focused monitor:
<ul>
<li><code>swayosd-client --monitor &quot;$(hyprctl monitors -j | jq -r '.[] | select(.focused == true).name')&quot;</code></li>
</ul>
</li>
</ul>
<h2 id="osd-integration">OSD Integration</h2>
<ul>
<li>ddcutil getvcp 10 returns a line containing “current value” and “maximum value”.</li>
<li>We parse it to get:
<ul>
<li>P (percent, e.g., 72)</li>
<li>R (ratio 0.00–1.00 for a progress bar)</li>
</ul>
</li>
<li>SwayOSD’s --custom-progress shows a clean bar without changing any backlight devices:
<ul>
<li>--custom-progress &quot;$R&quot;</li>
<li>--custom-progress-text &quot;Brightness: $P%&quot;</li>
<li>--custom-icon display-brightness</li>
</ul>
</li>
</ul>
<h2 id="testing">Testing</h2>
<ul>
<li>Ensure the script is executable: chmod +x ~/bin/hdmi-brightness</li>
<li>Reload Hyprland: hyprctl reload</li>
<li>Press brightness keys and Alt+F1/F2:
<ul>
<li>External monitor brightness changes (DDC/CI)</li>
<li>OSD shows an accurate bar and percentage</li>
</ul>
</li>
<li>If no OSD appears:
<ul>
<li>systemctl --user enable --now swayosd</li>
<li>Keep a window on the monitor you want the OSD (defaults to focused)</li>
</ul>
</li>
</ul>
<h2 id="troubleshooting">Troubleshooting</h2>
<ul>
<li>No brightness change: confirm ddcutil works (ddcutil detect, ddcutil getvcp 10), user in i2c group, and i2c-dev is loaded.</li>
<li>Different keycodes: use wev to check actual keysyms and update the binds accordingly.</li>
<li>OSD on the wrong output: we can pin $osdclient to a specific monitor name (e.g., --monitor &quot;HDMI-A-1&quot;).</li>
</ul>
<h2 id="why-this-works">Why This Works</h2>
<ul>
<li>It replaces backlight-centric controls with DDC/CI, which external monitors use.</li>
<li>The OSD is decoupled from any system backlight and directly reflects DDC/CI state, so it’s always accurate.</li>
</ul>
						<hr>
                </div>       
                <div>
                    <a href="/posts/omarchy-brightness">
                        <h2>Omarchy - Setting screen brightness over HDMI by terminal</h2>
                    </a>
                    <p>Posted on Wednesday, 10 September 2025</p>
<h1 id="omarchy">Omarchy</h1>
<p>With the coming arrival of the end of Windows10, I installed <a href="https://omarchy.org/">Omarchy</a> on one my <a href="https://www.bee-link.com/products/beelink-mini-s12-n95">Beelink MiniS12 N95</a>, fully expecting just to play with it and revert back to Windows11 on the machine. Win11 was slow on the machine, but a decent cheap desktop to have connected to a screen. <em>Omarchy</em> on the Beelink, even on the tiny hardware, has been absolutely flying. To the point that it's now my main desktop for everything right now.</p>
<p>One thing I needed to do is to handle the brightness of the screen, from the command line, so I could toggle the screen brightness from the command line. I discovered I could use <code>ddcutil</code> which I installed using the package manager on Omarchy.</p>
<pre><code>sudo ddcutil detect
Display 1
   I2C bus:  /dev/i2c-0
   DRM_connector:           card1-HDMI-A-2
   EDID synopsis:
      Mfg id:               BNQ - UNK
      Model:                BenQ EL2870U
      Product code:         31049  (0x7949)
      Serial number:        58M02252SL0
      Binary serial number: 21573 (0x00005445)
      Manufacture year:     2021,  Week: 34
   VCP version:         2.2
</code></pre>
<p>My screen is connected by HDMI, do I was able to get the information on it.</p>
<pre><code>~ ❯ sudo usermod -aG i2c $USER
</code></pre>
<p>So I didn't want to sudo all the time for my screen display information, I added my user the control of the i2c bus. This could be a security weakening, there's other ways to do it, but for my case it's fine.</p>
<pre><code>~ ❯ ddcutil detect
Display 1
   I2C bus:  /dev/i2c-0
   DRM_connector:           card1-HDMI-A-2
   EDID synopsis:
      Mfg id:               BNQ - UNK
      Model:                BenQ EL2870U
      Product code:         31049  (0x7949)
      Serial number:        58M02252SL0
      Binary serial number: 21573 (0x00005445)
      Manufacture year:     2021,  Week: 34
   VCP version:         2.2
</code></pre>
<p>Then getting and setting the brightness was done with the following commands: <code>ddcutil getvcp 10</code> and <code>ddcutil setvcp 10 20</code></p>
<pre><code>~ ❯ ddcutil getvcp 10
VCP code 0x10 (Brightness                    ): current value =    40, max value =   100

~ ❯ ddcutil setvcp 10 20
</code></pre>
<p>To get a listing of what codes the screen supports, you can use <code>ddcutil capabilities</code>.</p>
<pre><code>ddcutil capabilities
Model: EL2870U
MCCS version: 2.2
Commands:
   Op Code: 01 (VCP Request)
   Op Code: 02 (VCP Response)
   Op Code: 03 (VCP Set)
   Op Code: 07 (Timing Request)
   Op Code: 0C (Save Settings)
   Op Code: E3 (Capabilities Reply)
   Op Code: F3 (Capabilities Request)
VCP Features:
   Feature: 02 (New control value)
   Feature: 04 (Restore factory defaults)
   Feature: 05 (Restore factory brightness/contrast defaults)
   Feature: 08 (Restore color defaults)
   Feature: 0B (Color temperature increment)
   Feature: 0C (Color temperature request)
   Feature: 10 (Brightness)
   Feature: 12 (Contrast)
   Feature: 14 (Select color preset)
      Values:
         04: 5000 K
         05: 6500 K
         08: 9300 K
         0b: User 1
   Feature: 16 (Video gain: Red)
   Feature: 18 (Video gain: Green)
   Feature: 1A (Video gain: Blue)
   Feature: 52 (Active control)
   Feature: 60 (Input Source)
      Values:
         0f: DisplayPort-1
         11: HDMI-1
         12: HDMI-2
   Feature: 62 (Audio speaker volume)
   Feature: 72 (Gamma)
      Invalid gamma descriptor: 50 64 78 8c a0
   Feature: 7D (Unrecognized feature)
      Values: 00 01 02 (interpretation unavailable)
   Feature: 7E (Trapezoid)
      Values: 03 0F 10 11 12 (interpretation unavailable)
   Feature: 7F (Unrecognized feature)
   Feature: 80 (Keystone)
      Values: 01 02 03 (interpretation unavailable)
   Feature: 86 (Display Scaling)
      Values:
         01: No scaling
         02: Max image, no aspect ration distortion
         05: Max vertical image with aspect ratio distortion
         0c: Unrecognized value
         10: Unrecognized value
         11: Unrecognized value
         13: Unrecognized value
         14: Unrecognized value
         15: Unrecognized value
         16: Unrecognized value
         17: Unrecognized value
   Feature: 87 (Sharpness)
   Feature: 8D (Audio mute/Screen blank)
      Values: 01 02 (interpretation unavailable)
   Feature: AC (Horizontal frequency)
   Feature: AE (Vertical frequency)
   Feature: B2 (Flat panel sub-pixel layout)
   Feature: B6 (Display technology type)
   Feature: C0 (Display usage time)
   Feature: C6 (Application enable key)
   Feature: C8 (Display controller type)
   Feature: C9 (Display firmware level)
   Feature: CA (OSD/Button Control)
      Values:
         01: OSD disabled, button events enabled
         02: OSD enabled, button events enabled
   Feature: CC (OSD Language)
      Values:
         01: Chinese (traditional, Hantai)
         02: English
         03: French
         04: German
         05: Italian
         06: Japanese
         07: Korean
         09: Russian
         0a: Spanish
         0b: Swedish
         0d: Chinese (simplified / Kantai)
         0e: Portuguese (Brazil)
         0f: Arabic
         12: Czech
         14: Dutch
         1a: Hungarian
         1e: Polish
         1f: Romanian
   Feature: D6 (Power mode)
      Values:
         01: DPM: On,  DPMS: Off
         05: Write only value to turn off display
   Feature: DA (Scan mode)
      Values:
         00: Normal operation
         02: Overscan
   Feature: DC (Display Mode)
      Values:
         04: User defined
         05: Games
         0b: Unrecognized value
         0c: Unrecognized value
         0e: Unrecognized value
         0f: Unrecognized value
         12: Unrecognized value
         13: Unrecognized value
         21: Unrecognized value
   Feature: DF (VCP Version)
</code></pre>
<p>This was what my BenQ exposes.</p>
<h2 id="ease-of-use">Ease of use</h2>
<p>Discovered that ddcutil allows relative up downs:</p>
<pre><code>~ ❯ ddcutil setvcp 10 + 10
~ ❯ ddcutil setvcp 10 - 10
</code></pre>
<h2 id="next-steps">Next steps</h2>
<p>I need to figure out how to wire up these commands to the brightness up / down key commands on Omarchy - so I can control the brightness on the keyboard. Still not sure how to get that configuration working, since it doesn't work out of the box with my screen with the default tooling.</p>
						<hr>
                </div>       
                <div>
                    <a href="/posts/MIQP">
                        <h2>It&#x2019;s a proportional allocation - how hard can it be? Going from Water filling to QP</h2>
                    </a>
                    <p>Posted on Wednesday, 16 April 2025</p>
<h1 id="its-a-proportional-allocation-how-hard-can-it-be-miqp">It’s a proportional allocation - how hard can it be? MIQP</h1>
<p>Alice, Bob and Charlie buy a pizza and they each put down a part of the price, respectively 50%, 30% and 20%. Pizza arrives and they slice it up and eat it. But Alice gets full after eating 40% of her 50% slice, how do we allocate the remaining 10% slice to Bob and Charlie? Her 10% can be cut up into 2% slices and we proportionally give 3 to Bob (total 36%) and 2 to Charlie (total 24%).</p>
<p>We have a total allocation of 100 MW of power to allocate to three products, in the ideal allocation with (0.5, 0.3, 0.2) ratio and each product has a maximum of 40MW.</p>
<p>These two problems are the same.</p>
<h2 id="waterfilling-algorithm">Waterfilling algorithm</h2>
<p>There exists a well known algorithm for solving this problem, the water filling algorithm.</p>
<p>In essence, we are looking at finding the level of water across three containers that is flat along the allocation amount.</p>
<h3 id="definitions">definitions:</h3>
<ul>
<li><span class="math">\(w_i\)</span> is the weight from product i</li>
<li><span class="math">\(w'_i\)</span> is the updated weight when we have fewer products due to saturation</li>
<li><span class="math">\(M_i\)</span> is the maximum of product i</li>
<li><span class="math">\(x'_i\)</span> is the initial / ideal allocation in case the products are not saturated</li>
<li><span class="math">\(x_i\)</span> is the current allocation to the product</li>
<li><span class="math">\(T\)</span> is total allocation amount to spread over the products</li>
<li><span class="math">\(T_r\)</span> is the remaining allocation to spread over products after the saturated products are removed from T</li>
<li><span class="math">\(saturated\)</span> : means that the allocation is &gt;= max on the product.</li>
<li><span class="math">\(unsaturated\)</span> : means that the allocation is &lt; max on the product</li>
</ul>
<h3 id="water-filling-iterative-algorithm">Water-Filling (Iterative) Algorithm:</h3>
<ul>
<li>Step 1: Compute the ideal allocations <span class="math">\(x'_i = w_i \cdot T\)</span></li>
<li>Step 2: For any product i for which <span class="math">\(x'_i &gt;= M_i\)</span> (saturated), set <span class="math">\(x_i =M_i\)</span>, otherwise <span class="math">\(x_i = x'_i\)</span>.</li>
<li>Step 3: Compute the remaining capacity by removing the capacity of saturated <span class="math">\(x_i\)</span> : <span class="math">\(T_r = T − \sum_{i_{\text{saturated}}} M_i\)</span>.</li>
<li>Step 4: For the remaining (unsaturated) products, redistribute <span class="math">\(T_r\)</span> proportionally based on their weights normalized over the unsaturated set <span class="math">\(x_i = w^{\prime}_i \cdot T_r\)</span> where <span class="math">\(w^{\prime}_i = \frac{w_i}{\sum_j w_j}\)</span> with <span class="math">\(j\)</span> representing the unsaturated products</li>
<li>Step 5: Repeat the process if additional products get saturated during the redistribution, ie. from Step 2.</li>
</ul>
<p>The reason this terminates is that because we remove saturated products from the list, the next products get allocated and the set gets reduced, either a new product is saturated and the cycle continues or the final allocation is done and terminates.</p>
<pre><code class="language-python">import numpy as np

def iterative_waterfilling(T, weights, max_allocations):
    n = len(weights)
    allocations = np.zeros(n)
    unsaturated = np.array([True] * n)
    remaining_T = T

    while True:
        # Calculate proportional weights for unsaturated products
        current_weights = np.array(weights) * unsaturated
        total_current_weight = np.sum(current_weights)
        
        # Calculate ideal allocation for unsaturated products
        ideal_allocations = (current_weights / total_current_weight) * remaining_T

        # Check for saturation
        newly_saturated = ideal_allocations &gt;= max_allocations
        
        # Update allocations and saturation status
        if not np.any(newly_saturated &amp; unsaturated):
            allocations[unsaturated] = ideal_allocations[unsaturated]
            break
        
        for i in range(n):
            if unsaturated[i] and newly_saturated[i]:
                allocations[i] = max_allocations[i]
                unsaturated[i] = False
                remaining_T -= allocations[i]

    return allocations

T = 100
weights = [0.5, 0.3, 0.2]
max_allocations = [40, 40, 40]

allocations_result = iterative_waterfilling(T, weights, max_allocations)
print(&quot;Iterative Waterfilling Result:&quot;, allocations_result)
</code></pre>
<h3 id="examples">Examples</h3>
<p>Example 1 - total 100, allocation (0.5,0.3,0.2), maximum (40,40,40), result (40,36,24)</p>
<p>Example 2 - total 100, allocation (0.5,0.3,0.2), maximum (40,34,40), result (40,34,26)</p>
<p>The problem of this algorithm is that while it works wonderfully for simple proportional problems, as soon as you start adding more constraints (minimums) and relations between the allocations, this iterative algorithm doesn’t work that great.</p>
<p>So how do we solve this as an optimization problem? We want to find a solution that when unconstrained (unsaturated) falls back to the proportional allocation and when constrained (saturated maximum) falls back to the waterfilling algorithm.</p>
<h2 id="from-waterfilling-to-qp-mixed-integer-quadratic-programming">From Waterfilling to QP : Mixed integer quadratic programming</h2>
<p>While the iterative waterfilling algorithm effectively solves basic proportional allocation problems, it struggles under more complex scenarios involving additional constraints, such as minimum allocation limits or relational constraints between allocations. To robustly handle these real-world complexities, we leverage Mixed Integer Quadratic Programming (MIQP). MIQP elegantly generalizes the waterfilling logic into an optimization framework, allowing precise specification of constraints and objectives. By translating allocation decisions into a mathematical optimization problem, we ensure optimal, constraint-respecting allocations, making it suitable for applications demanding reliability and flexibility.</p>
<h3 id="definitions-1">Definitions:</h3>
<ul>
<li><span class="math">\(T\)</span>: total</li>
<li><span class="math">\(w_i\)</span>: weight</li>
<li><span class="math">\(M_i\)</span>: Maximum of allocation</li>
<li><span class="math">\(d_i\)</span>: product saturated marker ($\in \mathbb, binary \in \lbrace 0,1 \rbrace $), 0 unsaturated, 1 saturated</li>
<li><span class="math">\(x_i\)</span>: allocation amount</li>
<li><span class="math">\(v_i\)</span>: target water level for unsaturated product (shared identity)</li>
<li><span class="math">\(U\)</span>: upper large bound</li>
</ul>
<h3 id="objective">Objective:</h3>
<p><span class="math">\(\min \sum_i (x_i - w_i T)^2\)</span></p>
<h3 id="constraints">Constraints:</h3>
<h4 id="i-basic-allocation-limits">(I) Basic allocation limits</h4>
<p><span class="math">\(\forall i \quad x_i \geq 0 \quad (a)\)</span></p>
<p><span class="math">\(\forall i \quad x_i \leq M_i \quad (b)\)</span></p>
<h4 id="ii-total-allocation-constraint">(II) Total allocation constraint</h4>
<p><span class="math">\(\sum_i x_i \leq T\)</span></p>
<h4 id="iii-saturation-constraints">(III) Saturation constraints <span class="math">\(\forall i\)</span></h4>
<p><span class="math">\(x_i = w_i \cdot v_i + M_i \cdot d_i \quad (a)\)</span></p>
<p><span class="math">\(v_i \leq U \cdot (1 - d_i) \quad (b) \quad \text{with } v_i = 0 \text{ when saturated}\)</span></p>
<p><span class="math">\(v_i \geq 0 \quad (c)\)</span></p>
<p><span class="math">\(v_i \leq \frac{M_i}{w_i} \cdot (1 - d_i) + U \cdot d_i \quad (d)\)</span></p>
<h4 id="iv-water-level-equality-constraints-across-unsaturated-products">(IV) Water level equality constraints across unsaturated products</h4>
<p><span class="math">\(\forall i (1 \rightarrow n), \quad \forall j (i+1 \rightarrow n)\)</span></p>
<p><span class="math">\(v_i - v_j \leq U \cdot (d_i + d_j)\)</span></p>
<p><span class="math">\(v_j - v_i \leq U \cdot (d_i + d_j)\)</span></p>
<p><em>If both are unsaturated, it means <span class="math">\(d_i = d_j = 0\)</span>, thus forcing <span class="math">\(v_i = v_j\)</span>.</em></p>
<h3 id="explanation-of">Explanation of <span class="math">\(v_i\)</span></h3>
<p>This set of equations sets up <span class="math">\(v_i\)</span> as a shared value <span class="math">\(z\)</span> across all unsaturated products.</p>
<p>$$40 + (w_1 + w_2) \cdot z = 100$$</p>
<p><span class="math">\((0.3 + 0.2) z = 60\)</span></p>
<p><span class="math">\(z = 120\)</span></p>
<p><span class="math">\(x_1 = 0.3 \cdot 120 = 36\)</span></p>
<p><span class="math">\(x_2 = 0.2 \cdot 120 = 24\)</span></p>
<h3 id="implementation-in-python">Implementation in Python</h3>
<pre><code class="language-python">#pip install numpy
#pip install cvxpy
#pip install ecos

import cvxpy as cp
import numpy as np

# Problem parameters
T = 100.0
w = [0.5, 0.3, 0.2]          # target weights for products 1, 2, and 3
M_max = [40.0, 40.0, 40.0]     # maximum allocation for each product

# Number of products
n = len(w)

# A sufficiently large constant U (big-M) for enforcing water-level equality.
U = 500.0

# Decision variables:
# x: allocation amounts
x = cp.Variable(n)
# v: auxiliary &quot;water-level&quot; variables for unsaturated products
v = cp.Variable(n)
# delta: binary variables; delta[i] = 1 means product i is saturated (x[i] = M_max[i])
delta = cp.Variable(n, boolean=True)

constraints = []

# For each product, define the allocation as the sum of the unsaturated part and the saturation term.
for i in range(n):
    # If not saturated (delta[i] = 0) then x[i] = w[i]*v[i].
    # If saturated (delta[i] = 1) then x[i] = M_max[i].
    constraints.append(x[i] == w[i] * v[i] + M_max[i] * delta[i])
    
    # Force v[i] = 0 when saturated, by bounding v[i] to 0 when delta[i]=1.
    constraints.append(v[i] &lt;= U * (1 - delta[i]))
    # Ensure nonnegativity of v.
    constraints.append(v[i] &gt;= 0)
    # When unsaturated (delta[i]=0), we must have x[i] = w[i]*v[i] ≤ M_max[i]. 
    # Throught: Why not T here instead of M_max[i]? -&gt; it would be correct, but M_max[i] is a more restrictive boundary so helps convergence
    constraints.append(v[i] &lt;= (M_max[i] / w[i]) * (1 - delta[i]) + U * delta[i])

# Enforce that all unsaturated products share the same water-level.
# For every pair (i,j), if both are unsaturated (delta[i] = delta[j] = 0) then v[i] must equal v[j].
for i in range(n):
    for j in range(i+1, n):
        constraints.append(v[i] - v[j] &lt;= U * (delta[i] + delta[j]))
        constraints.append(v[j] - v[i] &lt;= U * (delta[i] + delta[j]))

# Total allocation constraint: the sum of all allocations must equal the available capacity.
constraints.append(cp.sum(x) == T)

# Ensure each x[i] does not exceed its maximum. (These could be built in via the definition of x.)
for i in range(n):
    constraints.append(x[i] &gt;= 0)
    constraints.append(x[i] &lt;= M_max[i])

# Define the target allocation for each product (unconstrained ideals)
target = np.array([w_i * T for w_i in w])

# Objective: minimize squared deviation from the ideal allocation.
objective = cp.Minimize(cp.sum_squares(x - target))

# Define and solve the MIQP.
# Use a MIQP-capable solver such as GUROBI, CPLEX, ECOS_BB, etc.
prob = cp.Problem(objective, constraints)
result = prob.solve(solver=cp.ECOS_BB)


print(&quot;Status:&quot;, prob.status)
print(&quot;Optimal value:&quot;, result)
print(&quot;Optimal allocations:&quot;)
for i in range(n):
    print(f&quot;  x[{i+1}] = {x.value[i]:.4f}&quot;)
print(&quot;Water-level (v) values:&quot;)
for i in range(n):
    print(f&quot;  v[{i+1}] = {v.value[i]:.4f}&quot;)
print(&quot;Saturation indicators (delta) values:&quot;)
for i in range(n):
    print(f&quot;  delta[{i+1}] = {delta.value[i]:.4f}&quot;)

# Expected behavior for this example:
# - For product 1, the unconstrained target is 50 but M_max[0]=40, so we expect it to be saturated (delta[0]=1, x[0]=40).
# - For products 2 and 3 (unsaturated, delta = 0), they share the same water-level z.
#   The total allocation constraint becomes: 40 + (w[1] + w[2]) * z = 100  --&gt;  (0.3+0.2)*z = 60, so z = 120.
#   Hence, x[2] = 0.3 * 120 = 36 and x[3] = 0.2 * 120 = 24.
</code></pre>
<h2 id="summary">Summary</h2>
<p>In business applications, we often see allocations that should be &quot;preference based&quot; if unconstrained, but then with different constraints it becomes complicated to tease out the preferences in an optimal way. This QP application shows a way to have an allocation identical to the water filling, but with the flexibility of QP.</p>
<p>If you were simplifying the QP constraints to remove the equations (IV), the output would be (40, 35, 25) since that minimises the objective function.</p>
<p>This example here is taken out of an abstration of a practical problem of allocating ancillary service capacity to a series of contracts, with trader preferences. This chapter is part of my book &quot;Energy - From Asset to Cashflow&quot; (not yet published).</p>
						<hr>
                </div>       
        <ul class="pager">
            <li class="previous">                
            </li>
            <li class="next">
            </li>
        </ul>
    </div>
    <div class="4u 12u$(medium)">

            <h5>Tags</h5>
            <ul class="actions small">
                    <li><a role="button" href="/tags/Migrated" class="button small">Migrated (38)</a></li>
                    <li><a role="button" href="/tags/Thoughts" class="button small">Thoughts (12)</a></li>
                    <li><a role="button" href="/tags/Architecture" class="button small">Architecture (12)</a></li>
                    <li><a role="button" href="/tags/Database" class="button small">Database (11)</a></li>
                    <li><a role="button" href="/tags/CSharp" class="button small">CSharp (10)</a></li>
                    <li><a role="button" href="/tags/Jupyter-notebook" class="button small">Jupyter notebook (7)</a></li>
                    <li><a role="button" href="/tags/Oracle" class="button small">Oracle (7)</a></li>
                    <li><a role="button" href="/tags/Dotnet-try" class="button small">Dotnet try (7)</a></li>
                    <li><a role="button" href="/tags/Rpi" class="button small">Rpi (4)</a></li>
                    <li><a role="button" href="/tags/R" class="button small">R (4)</a></li>
            </ul>
            <ul class="actions small">
                <li><a href="/tags" class="button small">View All Tags &rarr;</a></li>
            </ul>    

            <h5>Older Posts</h5>
            <ul>
                    <li><a href="/posts/SimplePerf3">In-memory software design 2025 ? - from 40GB/s to 55GB/s</a></li>
                    <li><a href="/posts/SimplePerf2">In-memory software design 2025 - Applied to energy</a></li>
                    <li><a href="/posts/SimplePerf">Performance of in-memory in 2025</a></li>
                    <li><a href="/posts/network-tailscale">Network with Tailscale</a></li>
            </ul>
                <ul class="actions small">
                    <li><a href="/posts" class="button small">Archive &rarr;</a></li>
                </ul>

        
    </div> 
</div>
					</div>
				</div>
			</div>

			<!-- Footer -->
			<footer id="footer">
				<div class="inner">
    <section>
        <h2>Feeds</h2>
        <ul class="actions small vertical">
            <li><a href="/feed.rss" class="button small"><i class="fa fa-rss"></i> RSS Feed</a></li>
                        <li><a href="/feed.atom" class="button small"><i class="fa fa-rss"></i> Atom Feed</a></li>
        </ul>
    </section>
    <section>
    </section>
    <ul class="copyright">
        <li>Copyright © 2025</li>
        <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
        <li><a href="https://wyam.io">Generated by Wyam</a></li>
    </ul>
</div>

			</footer>

		</div>
		
		

		<!-- Scripts -->
		<script>hljs.initHighlightingOnLoad();</script>
		<script src="/assets/js/jquery.min.js"></script>
		<script src="/assets/js/skel.min.js"></script>
		<script src="/assets/js/util.js"></script>
		<!--[if lte IE 8]><script src="/assets/js/ie/respond.min.js"></script><![endif]-->
		<script src="/assets/js/main.js"></script>

	</body>

</html>
