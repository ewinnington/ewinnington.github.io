
<!DOCTYPE html>
<!--
	Phantom by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html lang="en">

	<head>
		<title>Eric Winnington - Using Github actions to build Wyam and publish to github pages</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />		
        <link href="/assets/css/highlight.css" rel="stylesheet">
		<!--[if lte IE 8]><script src="/assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="/assets/css/main.css" />
		<!--[if lte IE 9]><link rel="stylesheet" href="/assets/css/ie9.css" /><![endif]-->
		<!--[if lte IE 8]><link rel="stylesheet" href="/assets/css/ie8.css" /><![endif]-->
        <link href="/assets/css/override.css" rel="stylesheet" />

		<meta name="description" content="A collection of thoughts, code and snippets." />
		<link type="application/rss+xml" rel="alternate" title="Eric Winnington" href="/feed.rss" />
				<link type="application/atom+xml" rel="alternate" title="Eric Winnington" href="/feed.atom" />
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="icon" href="/favicon.ico" type="image/x-icon">

		<meta name="application-name" content="Eric Winnington" />
		<meta name="msapplication-tooltip" content="Eric Winnington" />
		<meta name="msapplication-starturl" content="/" />

		<meta property="og:title" content="Eric Winnington - Using Github actions to build Wyam and publish to github pages" /> 
		<meta property="og:type" content="website" />
		<meta property="og:url" content="http://ewinnington.github.io/posts/wyam-github-actions" />
		<!-- TODO: More social graph meta tags -->

        <script src="/assets/js/highlight.pack.js"></script>   
		
        <meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@ewinnington" />
<meta name="twitter:title" content="Eric Winnington - Using Github actions to build Wyam and publish to github pages" />
<meta name="twitter:description" content="A collection of thoughts, code and snippets." />

<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
		
	</head>

	<body>
		<!-- Wrapper -->
		<div id="wrapper">

			<!-- Header -->
			<header id="header">
				<div class="inner">

					<!-- Logo -->
					<a href="/" class="logo">
						<span class="title">Eric Winnington</span>
					</a>

					<!-- Nav -->
					<nav>
						<ul>
							<li><a href="#menu">Menu</a></li>
						</ul>
					</nav>

				</div>
			</header>

			<!-- Menu -->
			<nav id="menu">
				<h2>Menu</h2>
				<ul>
					        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About Me</a></li>
        <li><a href="/videos">Videos on programming</a></li>

				</ul>
			</nav>

			<!-- Main -->
			<div id="main">
				<div class="inner">

    
<header>
    <h1>Using Github actions to build Wyam and publish to github pages</h1>
            <p><em>Published on Sunday, 3 November 2019</em></p>
            <ul class="actions small">
                    <li><a role="button" href="/tags/Github" class="button small">Github</a></li>
                    <li><a role="button" href="/tags/GithubActions" class="button small">GithubActions</a></li>
                    <li><a role="button" href="/tags/GithubPages" class="button small">GithubPages</a></li>
                    <li><a role="button" href="/tags/Wyam" class="button small">Wyam</a></li>
        </ul>     
</header>

					
					<div id="content">
						

<h1 id="introduction">Introduction</h1>
<p>Not that I have Wyam as a static site generator, I want to use <a href="https://github.com/features/actions">Github Actions</a> to automatically deploy it on push. This requires a quite few steps to setup, but I did it, now so can you!</p>
<p>Github actions is still in beta, so you'll have to enroll to use the functionality:
<img src="/posts/images/github-actions-wyam/EnrollActions.png" class="img-fluid" alt="EnrollActions" /></p>
<h1 id="setup-procedure">Setup procedure</h1>
<p>This setup assumes you have a local Wyam that is working on your local machine. You can easily set one up by <a href="http://ewinnington.github.io/posts/Switching-to-wyam">following these steps</a>. You can always have a look at my <a href="https://github.com/ewinnington/ewinnington.github.io">https://github.com/ewinnington/ewinnington.github.io</a> repository to see what I have configured in my config.wyam.</p>
<h2 id="personal-page">Personal page</h2>
<p>First you must have a <a href="https://pages.github.com/">Personal Page</a> setup in github. This is done by creating a public repository <em>username</em>.github.io.</p>
<p><img src="/posts/images/github-actions-wyam/CreateRepo.png" class="img-fluid" alt="RepoCreation" /></p>
<h3 id="create-the-correct-branches">Create the correct branches</h3>
<p>Inside that repository, you will want to create a second branch next to the master: source. This can be done by typing a new branch name in the Switch branches/tags text box.</p>
<p><img src="/posts/images/github-actions-wyam/SourceBranch.png" class="img-fluid" alt="SourceBranch" /></p>
<p>Next step is to make this branch the default when we push commits to the repository. This is because the <em>master</em> branch of the username.gitub.io is what is hosted on github's personal pages. Therefore the source of the wyam site has to be stored on another branch. To set the branch as default, Go to <em>Settings</em>, then <em>Branches</em> and select <strong>source</strong> in the dropdown box. Confirm with update.</p>
<p><img src="/posts/images/github-actions-wyam/SettingsBranches.png" class="img-fluid" alt="SettingsBranches" /></p>
<h3 id="prepare-keys-and-install-them">Prepare keys and install them</h3>
<p>We will be doing automated pushes from the <strong>source</strong> branch to the <strong>master</strong> branch, this means that we need to setup deploy keys and the associated secrets so that github allows us to update in an automated manner.</p>
<p>First, you need to generate your keys locally on your own machine with <code>ssh-keygen -t rsa -b 4096 -C &quot;Github-user-email&#64;example.com&quot; -f gh-pages -N &quot;&quot;</code>. You will need to replace <em>Github-user-email&#64;example.com</em> with your own, of course.</p>
<p>This will generate two files:</p>
<ul>
<li>gh-pages : the private key file, this will go into the secrets tab on github. I named the key <strong>ACTIONS_DEPLOY_KEY</strong>, this is important because we need to access it as an environment variable later in the action workflow script.</li>
<li>gh-pages.pub : the public key file, this will go to the deploy tab on github. I named my deploy key <em>public ACTIONS_DEPLOY_KEY</em>.</li>
</ul>
<p>Once installed, they should be like this in the github user interface of the repository:</p>
<p><img src="/posts/images/github-actions-wyam/SecretsKey.png" class="img-fluid" alt="Secrets" />
<img src="/posts/images/github-actions-wyam/DeployKey.png" class="img-fluid" alt="Deploy" /></p>
<h2 id="clone-the-repository-or-import-an-existing-git-repo">Clone the repository (or import an existing git repo)</h2>
<p>If you have nothing yet in the repository, I suppose you can now directly clone it from github using <code>git clone https://github.com/username/username.github.io</code> and it should come out all pre-prepared for you. Check something in and push.</p>
<h3 id="existing-repository">Existing repository</h3>
<p>I had an existing repository, so I had a few things to do with it before it was ready to be uploaded. I had already a master branch named <strong>master</strong>, so to make it conform with github, I renamed my local master branch with <code>git branch -m source </code>.</p>
<p>I then removed the previous origin before that was in use and I had to add the correct origin that I wanted to push to. Because I had previously had contents on the repository, I had to use the -f command on the push.</p>
<ul>
<li><code>git remote remove origin</code></li>
<li><code>git remote add origin https://github.com/username/username.github.io</code></li>
<li><code>git push -u -f origin source</code></li>
</ul>
<p>Now that I had pushed the Wyam blog, I was ready to setup the actions.</p>
<h4 id="side-note-good-wyam.gitignore-file">Side note - good wyam .gitignore file</h4>
<p>To avoid checking in the output files of the wyam build, I have the following .gitignore file in the repository:</p>
<pre><code>config.wyam.dll
config.wyam.hash
config.wyam.packages.xml
wwwroot
output
</code></pre>
<h2 id="setting-up-the-github-actions">Setting up the github actions</h2>
<p>First you will want to check that you are allowing external workflow scripts to be launched on your repository, since I will be relying on a few steps from pre-existing scripts.</p>
<p><img src="/posts/images/github-actions-wyam/SetupActions.png" class="img-fluid" alt="SetupActions.png" /></p>
<p>Here the first mistake I made while configuring actions was not going through the Github user interface and instead creating the folders manually in my github repository. I created <em>.github/workflow</em> instead of <strong>.github/workflows</strong> which meant that my actions were never kicking off. So don't make my mistake, use the github UI to set up the action and they will create the correct folder structure in your project.</p>
<p><img src="/posts/images/github-actions-wyam/SetUpActionsWorkflow.png" class="img-fluid" alt="Actions workflow" /></p>
<p>I setup a yaml file name <a href="https://github.com/ewinnington/ewinnington.github.io/blob/source/.github/workflows/wyam.yml">wyam.yml</a>. You can see what it looks like here below (I have included the code below on the page for you to copy and paste if you want. Let's go through this line by line.</p>
<p><img src="/posts/images/github-actions-wyam/wyam-yaml.png" class="img-fluid" alt="Wyam Yaml" /></p>
<p>Line 1: Name of the action that will appear in the action tab</p>
<p>Line 3-6: Triggers of the action. Here we trigger the action <strong>on push</strong> of <strong>branch source</strong>.</p>
<p>Line 8: List of jobs to run.
Line 9: First job is my build and deploy, I just called it build.</p>
<p>Line 11: The choice of the image to run on, like in docker. I chose ubuntu-latest.</p>
<p>Line 13: Each line prexifed with a - is a seperate action.</p>
<p>Line 14: Checkout the repository with the branch that has just been pushed. This is a standard github action, you can find <a href="https://github.com/actions/checkout">explanations here</a></p>
<p>Line 15: Installing .net core for Wyam.</p>
<p>Line 19-20: Installing Wyam. Here I install Wyam as a local tool by giving the <code>--tool-path .</code>, since if you install it as a global tool with <em>-g</em>, the build system won't find it due to .net core's requirement <a href="https://github.com/dotnet/cli/issues/8368">to restart the shell after being installed for the paths to be valid</a>.</p>
<p>Line 21-22: Running Wyam to render the blog to a set of static pages. Here is where you can change the template (Phantom) to something else if you want.</p>
<p>Line 23-28: We take the output of Wyam, which lives in the ./output folder and we use <a href="https://github.com/peaceiris/actions-gh-pages">peaceiris's github action for Github Pages</a> to publish our results to the correct branch <em>master</em> of our repository for deployment. We pass the <em>secrets.ACTIONS_DEPLOY_KEY</em> we defined earlier to allow the script to publish to the master branch.</p>
<pre><code class="language-yaml">name: Wyam

on:
  push:
    branches:
    - source  # default branch

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout&#64;v1
    - name: Setup .NET Core
      uses: actions/setup-dotnet&#64;v1
      with:
        dotnet-version: 2.1.802
    - name: Install Wyam
      run: dotnet tool install --tool-path . wyam.tool
    - name: Publish blog
      run: ./wyam -r blog -t Phantom
    - name: Deploy
      uses: peaceiris/actions-gh-pages&#64;v2.5.0
      env:
        ACTIONS_DEPLOY_KEY: ${{ secrets.ACTIONS_DEPLOY_KEY }}
        PUBLISH_BRANCH: master  # deploying branch
        PUBLISH_DIR: ./output

</code></pre>
<h2 id="running-the-workflow">Running the workflow</h2>
<p>Once you have setup this file, you can commit it and it should start off the build action. You can follow the progress of the action workflow on the github action page.</p>
<p><img src="/posts/images/github-actions-wyam/ActionOverview.png" class="img-fluid" alt="Action Overview" /></p>
<p>You can drill down into the details of the actions in case you had any failures. This is where I had the most trouble, but with these instructions, you should be fine.</p>
<p><img src="/posts/images/github-actions-wyam/ActionDetail.png" class="img-fluid" alt="Action Detail" /></p>
<h1 id="closing">Closing</h1>
<p>If all went well, you should now have your personal wyam generated site up and running at <a href="http://username.github.io">http://username.github.io</a> .</p>
<p>Please feel free to look around both branches <em>source</em> and <em>master</em> on <a href="https://github.com/ewinnington/ewinnington.github.io">my github repo</a> to understand how my blog is setup.</p>


<hr>
					</div>
				</div>
			</div>

			<!-- Footer -->
			<footer id="footer">
				<div class="inner">
    <section>
        <h2>Feeds</h2>
        <ul class="actions small vertical">
            <li><a href="/feed.rss" class="button small"><i class="fa fa-rss"></i> RSS Feed</a></li>
                        <li><a href="/feed.atom" class="button small"><i class="fa fa-rss"></i> Atom Feed</a></li>
        </ul>
    </section>
    <section>
    </section>
    <ul class="copyright">
        <li>Copyright © 2019</li>
        <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
        <li><a href="https://wyam.io">Generated by Wyam</a></li>
    </ul>
</div>

			</footer>

		</div>
		
		

		<!-- Scripts -->
		<script>hljs.initHighlightingOnLoad();</script>
		<script src="/assets/js/jquery.min.js"></script>
		<script src="/assets/js/skel.min.js"></script>
		<script src="/assets/js/util.js"></script>
		<!--[if lte IE 8]><script src="/assets/js/ie/respond.min.js"></script><![endif]-->
		<script src="/assets/js/main.js"></script>

	</body>

</html>
